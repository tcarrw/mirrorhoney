<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>MirrorHoney · Closeness</title>
<meta name="theme-color" content="#0b0d11" media="(prefers-color-scheme: dark)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{
  --bg:#090a0f;
  --ink:#f3f4ff;
  --muted:#b9b9d6;
  --glass:rgba(255,255,255,.06);
  --glass-2:rgba(255,255,255,.12);
  --pulse:#a7b7ff;
  --rose:#ff9ac7;
  --mint:#9af7e3;
  --gold:#ffd38a;
  --ring:0 0 0 2px rgba(167,183,255,.35);
  --radius:18px;
  --shadow:0 12px 40px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.05);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0;background:radial-gradient(1200px 900px at 70% -10%,rgba(167,183,255,.08),transparent 60%),
  radial-gradient(900px 700px at 10% 110%,rgba(255,154,199,.06),transparent 60%),var(--bg);
  color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
  overflow-x:hidden;
}
#alive{
  position:fixed;inset:0;pointer-events:none;mix-blend-mode:screen;opacity:.65;filter:saturate(1.05);
  background:
    radial-gradient(600px 600px at 15% 20%, rgba(167,183,255,.12), transparent 60%),
    radial-gradient(700px 700px at 85% 80%, rgba(255,211,138,.10), transparent 60%);
}
.shimmer{
  position:absolute;inset:0;background:
    repeating-linear-gradient(100deg,rgba(255,255,255,.02) 0,rgba(255,255,255,.02) 2px,transparent 2px,transparent 8px);
  animation:drift 16s linear infinite;
}
@keyframes drift{0%{transform:translateX(0)}100%{transform:translateX(-120px)}}

.wrap{max-width:1100px;margin:0 auto;padding:22px;display:grid;gap:22px}
.header{
display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-radius:20px;
background:linear-gradient(180deg,var(--glass-2),transparent);backdrop-filter:blur(8px);box-shadow:var(--shadow)
}
.brand{display:flex;gap:12px;align-items:center}
.glyph{
width:36px;height:36px;border-radius:12px;background:conic-gradient(from 220deg,rgba(167,183,255,.7),rgba(255,154,199,.7),rgba(167,183,255,.7));
box-shadow:0 0 0 1px rgba(255,255,255,.15),0 10px 25px rgba(0,0,0,.35)
}
.title{font-weight:700;letter-spacing:.4px}
.mode-select{display:flex;gap:8px}
.btn{
appearance:none;border:0;border-radius:12px;padding:10px 14px;background:rgba(255,255,255,.08);
color:var(--ink);font-weight:600;box-shadow:var(--shadow);transition:transform .12s ease,background .2s ease;cursor:pointer
}
.btn:active{transform:scale(.98)}
.btn.ghost{background:rgba(255,255,255,.05)}
.btn.pulse{box-shadow:0 0 0 2px rgba(167,183,255,.28),0 12px 32px rgba(167,183,255,.18)}
.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:22px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
.card{
background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.04));
border-radius:20px;padding:16px;box-shadow:var(--shadow);position:relative;overflow:hidden
}
.card .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.card h2{margin:0;font-size:16px;opacity:.9}
.field{display:flex;gap:8px;margin:10px 0}
.input, .select{
flex:1;border-radius:12px;border:1px solid rgba(255,255,255,.12);padding:10px 12px;background:rgba(10,10,15,.6);
color:var(--ink);outline:none
}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center}
.kbd{padding:3px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.2);font-size:12px}
.player-box{position:relative;aspect-ratio:16/9;border-radius:16px;overflow:hidden;background:#000;box-shadow:var(--shadow)}
.overlay{
position:absolute;inset:0;display:none;align-items:center;justify-content:center;backdrop-filter:blur(10px);
background:radial-gradient(600px 400px at 50% 40%,rgba(255,154,199,.16),transparent 60%),
linear-gradient(180deg,rgba(167,183,255,.1),rgba(10,10,15,.4))
}
.overlay.active{display:flex}
.overlay .mask{
width:min(90%,800px);padding:24px;border-radius:20px;background:rgba(10,12,18,.65);
border:1px solid rgba(255,255,255,.12);text-align:center;box-shadow:var(--shadow)
}
.tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);cursor:pointer;font-size:13px}
.tab.active{box-shadow:var(--ring);background:rgba(167,183,255,.18)}
.mirror{
min-height:64px;border-radius:14px;padding:12px 14px;background:rgba(255,255,255,.05);
border:1px solid rgba(255,255,255,.12);font-size:15px;color:var(--ink)
}
.echo{
font-size:22px;line-height:1.25;margin-top:10px;padding:14px;border-radius:14px;background:
linear-gradient(180deg,rgba(167,183,255,.12),rgba(255,154,199,.08));
text-shadow:0 0 18px rgba(167,183,255,.25)
}
.controls{display:grid;gap:12px}
.slider{width:100%}
.switch{position:relative;width:56px;height:32px;background:rgba(255,255,255,.12);border-radius:999px;cursor:pointer}
.switch i{position:absolute;top:4px;left:4px;width:24px;height:24px;border-radius:50%;background:white;transition:left .15s ease}
.switch.on i{left:28px}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12)}
.footer{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-top:6px}
.tint{
position:fixed;inset:0;pointer-events:none;mix-blend-mode:color;opacity:.0;background:radial-gradient(900px 900px at 50% 50%,rgba(167,183,255,.35),rgba(255,154,199,.25),transparent 70%)
}
.float-moon{
position:fixed;right:18px;bottom:18px;width:58px;height:58px;border-radius:16px;background:linear-gradient(180deg,rgba(167,183,255,.25),rgba(167,183,255,.15));
display:grid;place-items:center;box-shadow:0 10px 30px rgba(0,0,0,.45),var(--ring);backdrop-filter:blur(8px);user-select:none;touch-action:manipulation
}
.float-moon:active{transform:scale(.98)}
.float-moon span{font-size:22px}
.selfcheck{
position:fixed;inset:auto 12px 90px auto;right:12px;bottom:90px;width:min(420px,92vw);
display:none;border-radius:16px;padding:14px;background:rgba(12,14,20,.9);border:1px solid rgba(255,255,255,.12);box-shadow:var(--shadow);max-height:65vh;overflow:auto
}
.selfcheck.show{display:block}
.ok{color:#8affb3}.warn{color:#ffd38a}.err{color:#ff9aa2}
.hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);margin:8px 0}
.hidden{display:none}
.route-btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:rgba(255,255,255,.08);color:var(--ink);font-weight:600} </style>

</head>
<body>
<div id="alive"><div class="shimmer"></div></div>
<div class="tint" id="tint"></div>

<div class="wrap">
  <div class="header">
    <div class="brand">
      <div class="glyph"></div>
      <div>
        <div class="title">MirrorHoney</div>
        <div class="small">Closeness · 160 Hz · Quiet Mirror</div>
      </div>
    </div>
    <div class="mode-select">
      <button class="btn pulse" id="btnFeel">Feel</button>
      <button class="btn ghost" id="btnMirror">Mirror</button>
      <button class="btn ghost" id="btnRelease">Release</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="head">
        <h2>Player</h2>
        <div class="row small">
          <span class="badge" id="status">idle</span>
          <button class="btn" id="airplayBtn" title="Route video via AirPlay">Route</button>
        </div>
      </div>

```
  <div class="field">
    <input class="input" id="ytId" value="7zsDsWS6t0c" aria-label="YouTube ID">
    <button class="btn" id="loadBtn">Load</button>
  </div>

  <div class="player-box">
    <div id="player"></div>
    <div class="overlay" id="closeness">
      <div class="mask">
        <div class="tabs">
          <div class="tab active" data-mode="feel">feel</div>
          <div class="tab" data-mode="mirror">mirror</div>
          <div class="tab" data-mode="release">release</div>
        </div>
        <div class="small" id="modeHint">Calm breath. Notice one true sensation. Let it color the room.</div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="row small">
      <span class="kbd">Long-press ◐ for Self-Check</span>
      <span class="kbd">⌘K open Reflect</span>
    </div>
    <div class="row small" id="vidMeta"></div>
  </div>
</div>

<div class="card">
  <div class="head">
    <h2>Tone · 160 Hz</h2>
    <span class="small" id="toneState">off</span>
  </div>

  <div class="controls">
    <div class="row" style="justify-content:space-between">
      <div class="row" style="gap:8px">
        <div class="switch" id="toneToggle"><i></i></div>
        <span class="small">tone</span>
      </div>
      <span class="badge" id="hzReadout">160.00 Hz</span>
    </div>

    <input type="range" min="140" max="180" step="0.01" value="160" class="slider" id="hzSlider" aria-label="Frequency slider">

    <div class="row" style="justify-content:space-between">
      <div class="row" style="gap:8px">
        <div class="switch" id="persistToggle"><i></i></div>
        <span class="small">keep alive when switching apps</span>
      </div>
      <span class="small" id="persistNote">uses background-friendly oscillator</span>
    </div>

    <div class="row" style="gap:12px">
      <button class="btn" id="savePreset">Save preset</button>
      <button class="btn ghost" id="loadPreset">Load preset</button>
    </div>
  </div>

  <div class="hr"></div>

  <div class="head">
    <h2>Reflect</h2>
    <span class="small">Moon echo saves locally</span>
  </div>
  <textarea id="reflect" class="mirror" placeholder="Write one honest line…"></textarea>
  <div class="echo" id="echo"></div>
</div>
```

  </div>
</div>

<button class="float-moon" id="moon"><span>◐</span></button>

<div class="selfcheck" id="selfcheck">
  <div class="row" style="justify-content:space-between;align-items:center">
    <strong>Self-Check</strong>
    <button class="btn ghost" id="scRun">Run</button>
  </div>
  <div class="hr"></div>
  <div id="scLog" class="small"></div>
</div>

<video id="routeProbe" playsinline x-webkit-airplay="allow" class="hidden"></video>

<script>
let player, apiReady=false, readyResolve;
const ytIdEl=document.getElementById('ytId');
const loadBtn=document.getElementById('loadBtn');
const statusEl=document.getElementById('status');
const vidMeta=document.getElementById('vidMeta');
const closeness=document.getElementById('closeness');
const tabs=[...document.querySelectorAll('.tab')];
const modeHint=document.getElementById('modeHint');
const btnFeel=document.getElementById('btnFeel');
const btnMirror=document.getElementById('btnMirror');
const btnRelease=document.getElementById('btnRelease');
const tint=document.getElementById('tint');

const reflect=document.getElementById('reflect');
const echo=document.getElementById('echo');

const toneToggle=document.getElementById('toneToggle');
const hzSlider=document.getElementById('hzSlider');
const hzReadout=document.getElementById('hzReadout');
const toneState=document.getElementById('toneState');
const persistToggle=document.getElementById('persistToggle');

const moon=document.getElementById('moon');
const selfcheck=document.getElementById('selfcheck');
const scRun=document.getElementById('scRun');
const scLog=document.getElementById('scLog');
const airplayBtn=document.getElementById('airplayBtn');
const routeProbe=document.getElementById('routeProbe');

let longPressTimer=null;
let currentMode='feel';
let oscCtx=null, oscNode=null, gainNode=null, keepAlive=true;
let lastVisibilityTime=Date.now();
let continuityGaps=0;

function setBadge(el,text){el.textContent=text}

function setMode(mode){
  currentMode=mode;
  tabs.forEach(t=>t.classList.toggle('active',t.dataset.mode===mode));
  btnFeel.classList.toggle('pulse',mode==='feel');
  btnMirror.classList.toggle('pulse',mode==='mirror');
  btnRelease.classList.toggle('pulse',mode==='release');
  if(mode==='feel'){
    modeHint.textContent='Calm breath. Notice one true sensation. Let it color the room.';
    closeness.classList.add('active');
    tint.style.opacity='.18';
  }else if(mode==='mirror'){
    modeHint.textContent='Look gently. Reflect one sentence that feels exact.';
    closeness.classList.add('active');
    tint.style.opacity='.26';
  }else{
    modeHint.textContent='Exhale. Let the charge drain. Keep the learning.';
    closeness.classList.add('active');
    tint.style.opacity='.10';
  }
}
tabs.forEach(t=>t.addEventListener('click',()=>setMode(t.dataset.mode)));
btnFeel.onclick=()=>setMode('feel');
btnMirror.onclick=()=>setMode('mirror');
btnRelease.onclick=()=>setMode('release');

function closeOverlay(){closeness.classList.remove('active'); tint.style.opacity='.0'}
closeness.addEventListener('click',e=>{ if(e.target===closeness) closeOverlay() })

function loadSaved(){
  const savedId=localStorage.getItem('mh.ytid'); if(savedId) ytIdEl.value=savedId;
  const savedText=localStorage.getItem('mh.reflect'); if(savedText){reflect.value=savedText; echo.textContent=savedText}
  const f=localStorage.getItem('mh.freq'); if(f){hzSlider.value=+f; updateHzDisplay()}
  const p=localStorage.getItem('mh.keep'); if(p){keepAlive=p==='1'; persistToggle.classList.toggle('on',keepAlive)}
}
loadSaved();

function saveLocal(){
  localStorage.setItem('mh.ytid', ytIdEl.value.trim());
  localStorage.setItem('mh.reflect', reflect.value);
  localStorage.setItem('mh.freq', hzSlider.value);
  localStorage.setItem('mh.keep', keepAlive?'1':'0');
}

function updateHzDisplay(){hzReadout.textContent=(+hzSlider.value).toFixed(2)+' Hz'}

function initOsc(){
  if(oscCtx) return;
  oscCtx=new (window.AudioContext||window.webkitAudioContext)();
  gainNode=oscCtx.createGain(); gainNode.gain.value=0;
  oscNode=oscCtx.createOscillator(); oscNode.type='sine';
  oscNode.frequency.value=+hzSlider.value;
  oscNode.connect(gainNode).connect(oscCtx.destination);
  oscNode.start();
}

function toneOn(){
  initOsc();
  gainNode.gain.setTargetAtTime(.12,oscCtx.currentTime,.08);
  toneToggle.classList.add('on'); toneState.textContent='on';
}
function toneOff(){
  if(!oscCtx) return;
  gainNode.gain.setTargetAtTime(0,oscCtx.currentTime,.06);
  toneToggle.classList.remove('on'); toneState.textContent='off';
}
toneToggle.addEventListener('click',()=>{ if(toneToggle.classList.contains('on')) toneOff(); else toneOn(); saveLocal() });
hzSlider.addEventListener('input',()=>{ updateHzDisplay(); if(oscNode) oscNode.frequency.setValueAtTime(+hzSlider.value, oscCtx.currentTime) });
document.getElementById('savePreset').onclick=()=>{ localStorage.setItem('mh.preset', JSON.stringify({f:hzSlider.value,on:toneToggle.classList.contains('on')})) }
document.getElementById('loadPreset').onclick=()=>{
  const p=localStorage.getItem('mh.preset'); if(!p) return;
  const o=JSON.parse(p); hzSlider.value=o.f; updateHzDisplay();
  if(o.on){ toneOn() } else { toneOff() }
}
persistToggle.addEventListener('click',()=>{ keepAlive=!keepAlive; persistToggle.classList.toggle('on',keepAlive); saveLocal() });

reflect.addEventListener('input',()=>{ echo.textContent=reflect.value; saveLocal() });

document.addEventListener('keydown',e=>{
  if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); reflect.focus() }
});

function loadYouTubeAPI(){
  return new Promise(res=>{
    readyResolve=res;
    const tag=document.createElement('script');
    tag.src="https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);
  });
}
window.onYouTubeIframeAPIReady=function(){ apiReady=true; if(readyResolve) readyResolve() };

function initPlayer(id){
  setBadge(statusEl,'loading');
  if(player){ player.destroy(); player=null }
  player=new YT.Player('player',{
    videoId:id,
    playerVars:{playsinline:1,rel:0,modestbranding:1},
    events:{
      'onReady': (e)=>{
        setBadge(statusEl,'ready');
        const d=e.target.getVideoData();
        vidMeta.textContent=d && d.title? d.title+' — '+(d.author||'YouTube'): 'loaded';
      },
      'onStateChange': (ev)=>{
        if(ev.data===YT.PlayerState.PLAYING) setBadge(statusEl,'playing');
        if(ev.data===YT.PlayerState.PAUSED) setBadge(statusEl,'paused');
        if(ev.data===YT.PlayerState.ENDED) setBadge(statusEl,'ended ✓');
      }
    }
  });
}
loadBtn.addEventListener('click',()=>{ const id=ytIdEl.value.trim(); if(!id) return; saveLocal(); if(apiReady) initPlayer(id) });

(async ()=>{
  await loadYouTubeAPI();
  const id=ytIdEl.value.trim(); if(id) initPlayer(id);
})();

document.addEventListener('visibilitychange',()=>{
  const now=Date.now();
  const delta=now-lastVisibilityTime;
  if(document.visibilityState==='visible'){
    if(delta>120000 && keepAlive && oscCtx){ gainNode.gain.setTargetAtTime(.12,oscCtx.currentTime,.08) }
  }else{
    if(oscCtx && !keepAlive){ gainNode.gain.setTargetAtTime(0,oscCtx.currentTime,.05) }
    if(delta>15000) continuityGaps++;
  }
  lastVisibilityTime=now;
});

moon.addEventListener('touchstart',()=>{ longPressTimer=setTimeout(()=>{ selfcheck.classList.toggle('show') },650) },{passive:true});
moon.addEventListener('touchend',()=>{ if(longPressTimer){ clearTimeout(longPressTimer); longPressTimer=null } },{passive:true});
moon.addEventListener('mousedown',()=>{ longPressTimer=setTimeout(()=>{ selfcheck.classList.toggle('show') },650) });
moon.addEventListener('mouseup',()=>{ if(longPressTimer){ clearTimeout(longPressTimer); longPressTimer=null } });

function logSC(t, cls){ const p=document.createElement('div'); p.className=cls; p.textContent=t; scLog.appendChild(p) }
function clearSC(){ scLog.innerHTML='' }

async function runSelfCheck(){
  clearSC();
  logSC('Starting checks…','small');
  // 1) YouTube readiness
  if(player && typeof player.getPlayerState==='function'){
    logSC('YouTube API: ready ✓','ok');
  }else{
    logSC('YouTube API: not ready','err');
  }
  // 2) Video ID plays
  try{
    if(player && player.playVideo){ player.playVideo(); await new Promise(r=>setTimeout(r,1200)); }
    const st=player?player.getPlayerState():-1;
    if(st===1){ logSC('Video playback: playing ✓','ok') } else { logSC('Video playback: not playing','warn') }
  }catch(e){ logSC('Video playback: error','err') }
  // 3) Tone frequency accuracy
  try{
    initOsc();
    oscNode.frequency.setValueAtTime(+hzSlider.value,oscCtx.currentTime);
    const f=oscNode.frequency.value;
    const err=Math.abs(f-160);
    logSC('Tone frequency: '+f.toFixed(2)+' Hz','ok');
    if(err<=0.02){ logSC('Frequency accuracy: ±0.02 Hz ✓','ok') } else { logSC('Frequency accuracy: off by '+err.toFixed(2)+' Hz','warn') }
    toneOn();
  }catch(e){ logSC('Tone engine: error','err') }
  // 4) Overlay toggle
  try{
    closeness.classList.toggle('active');
    const active=closeness.classList.contains('active');
    closeness.classList.toggle('active');
    logSC('Closeness overlay toggle: '+(active?'ok':'ok'),'ok');
  }catch(e){ logSC('Closeness overlay: error','err') }
  // 5) Reflection persistence
  try{
    const prev=localStorage.getItem('mh.reflect')||'';
    const test='moon-echo-'+Math.random().toString(36).slice(2,6);
    localStorage.setItem('mh.reflect',test);
    const got=localStorage.getItem('mh.reflect');
    localStorage.setItem('mh.reflect',prev);
    logSC('Reflection storage: '+(got===test?'ok ✓':'mismatch'),'ok');
  }catch(e){ logSC('Reflection storage: error','err') }
  // 6) Continuity
  logSC('Continuity gaps this session: '+continuityGaps,'small');
}
scRun.addEventListener('click',runSelfCheck);

// AirPlay route picker for video (if available)
airplayBtn.addEventListener('click',()=>{
  try{
    if(routeProbe.webkitShowPlaybackTargetPicker){ routeProbe.webkitShowPlaybackTargetPicker() }
  }catch(e){}
});

// Autosave hooks
window.addEventListener('beforeunload',saveLocal);

// Start state
setMode('feel');
updateHzDisplay();
</script>

</body>
</html>
